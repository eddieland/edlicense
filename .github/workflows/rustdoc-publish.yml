name: Rustdoc Publish

on:
  workflow_run:
    workflows: ["Rust CI"]
    branches: [main]
    types:
      - completed
  # Allow manual triggering
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    # Only run if the Rust CI workflow completed successfully or if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
      
      - name: Build documentation
        run: |
          # Build documentation with all features
          RUSTDOCFLAGS="--html-in-header $(pwd)/.github/docs-header.html" cargo doc --no-deps --all-features
          
          # Create better redirects
          echo "<meta http-equiv=\"refresh\" content=\"0; url=edlicense/index.html\">" > target/doc/index.html
          
          # Create docs-header.html if it doesn't exist
          mkdir -p .github
          if [ ! -f .github/docs-header.html ]; then
            cat > .github/docs-header.html << 'EOL'
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
            <style>
              .content.unstable { display: block; }
              /* Add custom styles for documentation here */
            </style>
            EOL
          fi
          
          # Make sure the output directory exists
          mkdir -p _site
          
          # Copy documentation to a directory GitHub Pages can serve
          cp -r target/doc/* _site/
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4